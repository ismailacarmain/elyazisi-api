<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Yazƒ±sƒ± Edit√∂r√º Pro</title>
    <!-- Modern Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;       /* Indigo 500 */
            --primary-hover: #4f46e5; /* Indigo 600 */
            --accent: #8b5cf6;        /* Violet 500 */
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-hover: #6366f1;
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
            /* Mesh Gradient Background (Orijinal Tasarƒ±m) */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background: linear-gradient(-45deg, #e0e7ff, #f3e8ff, #eef2ff, #faf5ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* CONTAINER - Modern Floating Layout */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 30px;
            min-height: 100vh;
            align-items: start;
        }

        /* SIDEBAR - Floating Dock Style */
        .sidebar {
            position: sticky;
            top: 20px;
            padding: 30px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 50;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--glass-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .logo-img {
            width: 52px; height: 52px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        
        .logo-text h2 { font-size: 1.4em; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* AUTH SECTION */
        .auth-card {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: var(--radius-lg);
            padding: 15px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }
        .profile-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 50%; display: grid; place-items: center; font-weight: bold; }

        /* SETTINGS */
        .setting-group { margin-bottom: 24px; }
        .setting-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .setting-header label { font-size: 0.9em; font-weight: 600; color: var(--text-main); }
        
        .value-badge {
            background: white;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-width: 45px;
            text-align: center;
        }

        /* MODERN SLIDER */
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 6px;
            background: rgba(0,0,0,0.1); border-radius: 99px; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 22px; height: 22px;
            background: white; border: 2px solid var(--primary); border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* BUTTONS & SELECTS */
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: var(--radius-lg);
            font-size: 0.95em; font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 12px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }
        .btn-secondary { background: white; color: var(--text-muted); border: 1px solid rgba(0,0,0,0.1); }
        
        .toolbar-select {
            padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.8); width: 100%; margin-bottom: 10px;
            font-family: inherit; color: var(--text-main);
        }

        /* EDITOR AREA */
        .editor-container { display: flex; flex-direction: column; gap: 20px; }

        .editor-header {
            background: var(--glass-bg); padding: 20px 32px; border-radius: var(--radius-xl);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
        }

        .toolbar {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            padding: 10px 20px; border-radius: var(--radius-xl);
            border: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            gap: 15px; position: sticky; top: 20px; z-index: 40;
        }

        .workspace {
            background: white; border-radius: var(--radius-xl);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            overflow: hidden; display: grid; grid-template-columns: 1fr 1fr; 
            border: 1px solid white; min-height: 700px;
        }

        .input-area { padding: 30px; background: #fafafa; border-right: 1px solid rgba(0,0,0,0.05); }
        
        textarea {
            width: 100%; height: 100%; border: none; background: transparent;
            font-family: 'Inter', sans-serif; font-size: 1.1em; line-height: 1.7;
            color: var(--text-main); resize: none; padding: 0;
        }
        
        .canvas-wrapper {
            background: #334155;
            background-image: radial-gradient(#475569 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 40px; overflow: auto; 
            display: flex; justify-content: center; align-items: flex-start;
        }
        
        #mainCanvas {
            background: white; width: 100%; max-width: 794px; height: auto;
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5); border-radius: 2px;
        }

        /* LOADING */
        .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .progress-container { width: 300px; height: 4px; background: rgba(0,0,0,0.1); border-radius: 99px; overflow: hidden; margin-top: 20px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .container { display: block; padding: 0; }
            .sidebar { 
                position: fixed; left: 0; top: 0; bottom: 0; 
                transform: translateX(-100%); width: 300px; 
                border-radius: 0; margin: 0;
            }
            .sidebar.active { transform: translateX(0); }
            .editor-container { padding: 10px; }
            .workspace { grid-template-columns: 1fr; grid-template-rows: 300px 1fr; }
            .input-area { border-right: none; border-bottom: 1px solid #eee; }
            #mobileMenuBtn { display: block; }
        }
        @media (min-width: 1025px) { #mobileMenuBtn { display: none; } }

    </style>
</head>
<body>
    <div id="loadingScreen" class="loading">
        <h1 style="font-size: 3em; color: var(--primary);">‚úçÔ∏è</h1>
        <div class="progress-container"><div id="progressFill" class="progress-fill"></div></div>
        <p style="margin-top: 20px; color: var(--text-muted);">El yazƒ±sƒ± motoru y√ºkleniyor...</p>
    </div>

    <div class="container">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="logo-area">
                <!-- LOGO BURADA -->
                <img src="/static/logo.jpg" class="logo-img" onerror="this.style.display='none'">
                <div class="logo-text"><h2>Pro Yazƒ±</h2><span style="color:var(--text-muted); font-size:0.8em;">v3.0 Ultra</span></div>
                <button id="closeSidebar" class="btn-secondary" style="width: auto; margin-left: auto; display: none; padding: 5px 10px;">‚úï</button>
            </div>
            
            <!-- AUTH & PROFILE -->
            <div id="authSection">
                <button id="googleLoginBtn" class="btn btn-primary" style="background:#fff; color:#333; border:1px solid #ddd;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="18" style="margin-right:10px;"> Google ile Giri≈ü
                </button>
            </div>
            <div id="userProfile" class="auth-card" style="display: none;">
                <div class="profile-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div style="flex:1; overflow:hidden;">
                        <div id="userName" style="font-weight:700;">Kullanƒ±cƒ±</div>
                        <small id="userEmail" style="opacity:0.8;">...</small>
                    </div>
                    <button id="logoutBtn" style="background:none; border:none; cursor:pointer; color:white; font-size:1.2em;">üö™</button>
                </div>
            </div>

            <!-- FONT SE√áƒ∞Cƒ∞ -->
            <div class="setting-group" style="background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; margin-top: 10px;">
                <div class="setting-header"><label>üî§ Yazƒ± Tipi</label></div>
                <select id="fontSelector" class="toolbar-select">
                    <option value="" disabled selected>Y√ºkleniyor...</option>
                </select>
                <button id="refreshFontBtn" class="btn btn-primary" style="padding: 8px; font-size: 0.9em; margin-bottom: 0;">üîÑ Fontu Uygula</button>
            </div>

            <!-- AYARLAR -->
            <div class="setting-group">
                <div class="setting-header"><label>‚úèÔ∏è Yazƒ± Boyutu</label><span class="value-badge" id="scaleValue">140px</span></div>
                <input type="range" id="scaleSlider" min="30" max="250" value="140" step="10">
            </div>
            <div class="setting-group">
                <div class="setting-header"><label>üìè Satƒ±r Aralƒ±ƒüƒ±</label><span class="value-badge" id="lineHeightValue">220px</span></div>
                <input type="range" id="lineHeightSlider" min="40" max="400" value="220" step="10">
            </div>
            <div class="setting-group">
                <div class="setting-header"><label>üî† Harf Aralƒ±ƒüƒ±</label><span class="value-badge" id="letterSpacingValue">3px</span></div>
                <input type="range" id="letterSpacingSlider" min="-5" max="20" value="3" step="1">
            </div>
            <div class="setting-group">
                <div class="setting-header"><label>„Ä∞Ô∏è Doƒüallƒ±k</label><span class="value-badge" id="jitterValue">5</span></div>
                <input type="range" id="jitterSlider" min="0" max="20" value="5" step="1">
            </div>

            <button id="toggleTheme" class="btn btn-secondary" style="margin-top: 20px;">üåô Gece Modu</button>
            <button id="pdfBtn" class="btn btn-primary" style="margin-top: 10px;">üìÑ PDF ƒ∞ndir</button>
        </aside>

        <!-- EDITOR AREA -->
        <main class="editor-container">
            <header class="editor-header" style="padding: 15px 20px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <button id="mobileMenuBtn" class="btn-secondary" style="width: auto; padding: 8px 12px; margin:0;">‚ò∞</button>
                    <h1 style="font-size:1.2em; font-weight:700;">Belge √ñnizleme</h1>
                </div>
                <div>
                    <select id="paperSelect" class="toolbar-select" style="width:auto; display:inline-block; margin:0;">
                        <option value="cizgili">üìù √áizgili</option>
                        <option value="kareli">‚ñ¶ Kareli</option>
                        <option value="duz">‚¨ú D√ºz</option>
                    </select>
                </div>
            </header>

            <div class="workspace">
                <div class="input-area">
                    <textarea id="metinAlani" placeholder="Buraya yazƒ±n... Yazdƒ±klarƒ±nƒ±z saƒü tarafta el yazƒ±sƒ±na d√∂n√º≈üecek."></textarea>
                </div>
                <div class="canvas-wrapper">
                    <canvas id="mainCanvas"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="/static/js/engine.js"></script>
    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCc2VBYMe1ts8XjYE_YLMkG1rjf3NaD4Z0",
            authDomain: "elyazisiapp.firebaseapp.com",
            databaseURL: "https://elyazisiapp-default-rtdb.firebaseio.com",
            projectId: "elyazisiapp",
            storageBucket: "elyazisiapp.firebasestorage.app",
            messagingSenderId: "823659862878",
            appId: "1:823659862878:web:1615116c77d98f7f848dcf",
            measurementId: "G-DYW7TZ01T9"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}

        let editor = null;
        const metinAlani = document.getElementById('metinAlani');

        // --- 2. INIT ---
        async function init() {
            const loading = document.getElementById('loadingScreen');
            const progress = document.getElementById('progressFill');
            
            setTimeout(() => { if(loading.style.display!=='none') loading.style.display='none'; }, 3500);

            try {
                editor = new FinalHandwritingEditor('mainCanvas');
                await editor.loadAssets(p => progress.style.width = (p*100)+'%');
                loading.style.display = 'none';
                
                const saved = localStorage.getItem('saved_text');
                if(saved) { metinAlani.value = saved; editor.setText(saved); }
            } catch(e) { loading.style.display = 'none'; }
        }

        // --- 3. EDITOR LISTENERS ---
        metinAlani.addEventListener('input', () => {
            editor.setText(metinAlani.value);
            localStorage.setItem('saved_text', metinAlani.value);
        });
        ['click', 'keyup', 'focus'].forEach(evt => {
            metinAlani.addEventListener(evt, () => editor.setCursorIndex(metinAlani.selectionStart));
        });

        // --- 4. AUTH & FONTS ---
        firebase.auth().onAuthStateChanged(user => {
            if(user) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').textContent = user.displayName[0];
                loadFontList(user.uid);
            } else {
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('userProfile').style.display = 'none';
                loadFontList('');
            }
        });

        document.getElementById('googleLoginBtn').onclick = () => firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
        document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();

        async function loadFontList(uid) {
            const select = document.getElementById('fontSelector');
            const currentFont = new URLSearchParams(window.location.search).get('font_id');
            try {
                const res = await fetch(`/api/list_fonts?user_id=${uid}`);
                const data = await res.json();
                select.innerHTML = '<option value="">Varsayƒ±lan</option>';
                if (data.success && data.fonts) {
                    const myG = document.createElement('optgroup'); myG.label = "üìÇ Benim Fontlarƒ±m";
                    const pubG = document.createElement('optgroup'); pubG.label = "üåé Payla≈üƒ±lanlar";
                    data.fonts.forEach(f => {
                        const opt = new Option(f.name, f.id);
                        if(f.id === currentFont) opt.selected = true;
                        (f.type === 'private' ? myG : pubG).appendChild(opt);
                    });
                    select.add(myG); select.add(pubG);
                }
            } catch(e) {}
        }

        document.getElementById('refreshFontBtn').onclick = () => {
            const val = document.getElementById('fontSelector').value;
            const url = new URL(window.location);
            if(val) url.searchParams.set('font_id', val); else url.searchParams.delete('font_id');
            window.location.href = url.toString();
        };

        // --- 5. CONTROLS ---
        const bind = (id, method, labelId, unit='') => {
            document.getElementById(id).oninput = e => {
                editor[method](parseInt(e.target.value));
                if(labelId) document.getElementById(labelId).textContent = e.target.value + unit;
            };
        };
        bind('scaleSlider', 'setLetterScale', 'scaleValue', 'px');
        bind('lineHeightSlider', 'setLineHeight', 'lineHeightValue', 'px');
        bind('letterSpacingSlider', 'setLetterSpacing', 'letterSpacingValue', 'px');
        bind('jitterSlider', 'setJitter', 'jitterValue', '');

        document.getElementById('paperSelect').onchange = e => editor.setPaperType(e.target.value);
        document.getElementById('pdfBtn').onclick = () => editor.exportPDF();
        
        document.getElementById('toggleTheme').onclick = () => {
            const current = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', current==='dark'?'light':'dark');
        };

        // Responsive Menu
        const sb = document.getElementById('sidebar');
        document.getElementById('mobileMenuBtn').onclick = () => sb.classList.add('active');
        document.getElementById('closeSidebar').onclick = () => sb.classList.remove('active');

        window.onload = init;
    </script>
</body>
</html>
