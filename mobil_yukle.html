<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobil YÃ¼kleme - Fontify</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --bg-dark: #0a0a0f;
            --bg-card: #16161d;
            --text: #f8fafc;
            --border: #2d2d3a;
        }
        body { background: var(--bg-dark); color: var(--text); padding: 20px 10px; font-family: sans-serif; }
        .upload-btn {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .upload-btn:active { background: rgba(99, 102, 241, 0.1); border-color: var(--primary); transform: scale(0.98); }
        .upload-btn i { font-size: 3rem; color: var(--primary); margin-bottom: 10px; display: block; }
        .status-card { background: var(--bg-card); border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid var(--border); }
        .status-success { border-color: #22c55e; color: #22c55e; }
        .spinner-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
            border-radius: 14px; z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3 class="text-center mb-4">ðŸ“¸ FotoÄŸraf YÃ¼kle</h3>
        
        <div id="userInfo" class="text-center mb-2 text-muted small">
            BaÄŸlanÄ±yor...
        </div>

        <!-- Varyasyon SeÃ§imi (Hata Ã–nleyici) -->
        <div class="mb-4 text-center">
            <label class="form-label small text-muted">KaÄŸÄ±t TÃ¼rÃ¼ (KaÃ§ Tekrar?)</label>
            <select id="variationSelect" class="form-select form-select-sm mx-auto" style="max-width: 200px; background: #1e1e28; color: white; border-color: #2d2d3a;">
                <option value="1">1x (Her harften 1 tane)</option>
                <option value="3" selected>3x (Standart - 3 tane)</option>
                <option value="5">5x (Her harften 5 tane)</option>
                <option value="10">10x (Profesyonel)</option>
            </select>
        </div>

        <!-- Kamera Butonu -->
        <div class="upload-btn" onclick="document.getElementById('cameraInput').click()">
            <div id="uploadSpinner" class="spinner-overlay" style="display:none">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
            <i class="bi bi-camera-fill"></i>
            <h4>FotoÄŸraf Ã‡ek / YÃ¼kle</h4>
            <p class="small text-muted mb-0">Formun fotoÄŸrafÄ±nÄ± dik Ã§ekin.<br>4 kÃ¶ÅŸe marker gÃ¶rÃ¼nmeli.</p>
        </div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleUpload(this)">

        <!-- Ä°lerleme Listesi -->
        <h5 class="mt-4 mb-3">Ä°lerleme Durumu</h5>
        <div id="progressList">
            <!-- Dinamik olarak dolacak -->
            <div class="text-center text-muted py-3">HenÃ¼z yÃ¼kleme yapÄ±lmadÄ±.</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js"></script>
    <script>
        const API_BASE_URL = "https://elyazisi-api.onrender.com";
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('uid');
        const fontName = urlParams.get('fname');
        // URL'den gelen deÄŸeri al, yoksa 3 yap.
        const urlVCount = urlParams.get('vcount') || 3;
        
        // Select kutusunu ayarla
        document.getElementById('variationSelect').value = urlVCount;

        const fontId = `${userId}_${fontName.replace(/ /g, '_')}`;

        document.getElementById('userInfo').textContent = `Font: ${fontName}`;

        const sectionsFound = new Set();

        async function handleUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // GÃ¼ncel seÃ§imi al
            const currentVCount = document.getElementById('variationSelect').value;

            showSpinner(true);

            // Resmi sÄ±kÄ±ÅŸtÄ±r (Mobil upload hÄ±zlandÄ±rma iÃ§in)
            new Compressor(file, {
                quality: 0.8,
                maxWidth: 2500, // Yeterli Ã§Ã¶zÃ¼nÃ¼rlÃ¼k
                success(result) {
                    sendToServer(result, currentVCount);
                },
                error(err) {
                    alert('SÄ±kÄ±ÅŸtÄ±rma hatasÄ±: ' + err.message);
                    showSpinner(false);
                },
            });

            input.value = ''; // Reset input
        }

        async function sendToServer(file, vCount) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64data = reader.result.split(',')[1];

                try {
                    const response = await fetch(`${API_BASE_URL}/process_single`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            font_name: fontName,
                            image_base64: base64data,
                            variation_count: parseInt(vCount)
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        addSuccessStatus(data.section_id, data.detected_chars);
                        // TitreÅŸim bildirimi (mobil)
                        if (navigator.vibrate) navigator.vibrate(200);
                    } else {
                        alert("Hata: " + data.message);
                    }
                } catch (error) {
                    alert("Sunucu hatasÄ±: " + error.message);
                } finally {
                    showSpinner(false);
                }
            };
        }

        function addSuccessStatus(sectionId, count) {
            if (!sectionsFound.has(sectionId)) {
                sectionsFound.add(sectionId);
                // Listeyi temizle eÄŸer ilk ise
                if (sectionsFound.size === 1) document.getElementById('progressList').innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = 'status-card status-success d-flex justify-content-between align-items-center animate__animated animate__fadeIn';
            div.innerHTML = `
                <div>
                    <strong><i class="bi bi-check-circle-fill"></i> BÃ¶lÃ¼m ${sectionId}</strong>
                    <div class="small text-muted">${count} karakter bulundu</div>
                </div>
                <span class="badge bg-success">BaÅŸarÄ±lÄ±</span>
            `;
            
            // Varsa eski kaydÄ± sil (gÃ¼ncelleme gibi)
            const old = document.getElementById(`sec-${sectionId}`);
            if (old) old.remove();
            
            div.id = `sec-${sectionId}`;
            document.getElementById('progressList').prepend(div);
        }

        function showSpinner(show) {
            document.getElementById('uploadSpinner').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
