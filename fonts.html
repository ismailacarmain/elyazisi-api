<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Font K√ºt√ºphanesi - Fontify</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dfcv156wy/image/upload/v1767688541/favicon-32x32_q5k9p1.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; --bg-dark: #0a0a0f; --bg-card: #16161d; --bg-light: #1e1e28;
            --text: #f8fafc; --text-muted: #cbd5e1; --border: #2d2d3a;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
        .container { max-width: 1000px; padding: 40px 20px; }
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .header-brand h1 { font-size: 1.8rem; font-weight: 700; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .header-nav { display: flex; align-items: center; gap: 20px; }
        .nav-link-custom { color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: color 0.2s; }
        .nav-link-custom:hover { color: var(--primary); }
        .font-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .font-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; transition: all 0.2s; cursor: pointer; position: relative; }
        .font-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .font-preview { height: 100px; background: var(--bg-light); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        .font-info { padding: 15px; }
        .font-name { font-weight: 600; font-size: 1.1rem; margin-bottom: 5px; }
        .font-meta { font-size: 0.8rem; color: var(--text-muted); display: flex; justify-content: space-between; }
        .badge-private { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; background: rgba(99, 102, 241, 0.2); color: var(--primary); padding: 3px 8px; border-radius: 50px; }
        .card-actions { position: absolute; top: 10px; left: 10px; z-index: 20; display: flex; gap: 5px; }
        .action-btn { width: 28px; height: 28px; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .delete-btn { background: rgba(239, 68, 68, 0.2); color: #ef4444; } .delete-btn:hover { background: #ef4444; color: white; }
        .add-btn { background: rgba(99, 102, 241, 0.2); color: var(--primary); } .add-btn:hover { background: var(--primary); color: white; }
        .visibility-btn { background: rgba(255, 255, 255, 0.1); } .visibility-btn:hover { background: white; color: black !important; }
        .loading-spinner { display: flex; justify-content: center; padding: 50px; color: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <div class="header-brand d-flex align-items-center gap-3">
                <a href="editor.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> <span data-i18n="back_editor">Edit√∂re D√∂n</span></a>
                <h1 data-i18n="lib_title">Font K√ºt√ºphanesi</h1>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">üåê</button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#" id="langTrBtn">T√ºrk√ße</a></li>
                        <li><a class="dropdown-item" href="#" id="langEnBtn">English</a></li>
                    </ul>
                </div>
                <nav class="header-nav">
                    <a href="index.html" class="nav-link-custom"><i class="bi bi-house"></i> <span data-i18n="nav_home">Anasayfa</span></a>
                    <a href="ekle.html" class="nav-link-custom"><i class="bi bi-plus-circle"></i> <span data-i18n="nav_add">Ekle</span></a>
                </nav>
            </div>
        </div>

        <ul class="nav nav-pills mb-3" id="fontTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#my-fonts" data-i18n="tab_my_fonts">üìÇ Benim Fontlarƒ±m</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#public-fonts" data-i18n="tab_explore">üåç Ke≈üfet</button></li>
        </ul>

        <div class="mb-4">
            <div class="input-group">
                <span class="input-group-text bg-dark border-secondary text-muted"><i class="bi bi-search"></i></span>
                <input type="text" id="fontSearch" class="form-control bg-dark text-white border-secondary" data-i18n="search_lib" placeholder="Font adƒ± veya ID ile ara...">
            </div>
        </div>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="my-fonts"><div id="myFontsLoader" class="loading-spinner"><div class="spinner-border"></div></div><div id="myFontsGrid" class="font-grid"></div></div>
            <div class="tab-pane fade" id="public-fonts"><div id="pubFontsLoader" class="loading-spinner"><div class="spinner-border"></div></div><div id="pubFontsGrid" class="font-grid"></div></div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="background: var(--bg-card); color: var(--text);">
                <div class="modal-header border-secondary"><h5 class="modal-title" id="previewTitle">...</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body bg-dark" id="previewBody"></div>
                <div class="modal-footer border-secondary"><button class="btn btn-primary" id="useFontBtn"><i class="bi bi-pencil"></i> <span data-i18n="btn_use">Bu Fontla Yaz</span></button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="i18n.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCc2VBYMe1ts8XjYE_YLMkG1rjf3NaD4Z0", authDomain: "elyazisiapp.firebaseapp.com", projectId: "elyazisiapp" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const API_URL = 'https://elyazisi-api.onrender.com';
        let currentUserId = null, currentPreviewFontId = null, allMyFonts = [], allPubFonts = [];

        firebase.auth().onAuthStateChanged(user => { if (user) { currentUserId = user.uid; loadFonts(); } else { window.location.href = 'login.html'; } });

        async function loadFonts() {
            try {
                const res = await fetch(`${API_URL}/api/list_fonts?user_id=${currentUserId}`);
                const data = await res.json();
                if (data.success && data.fonts) {
                    allMyFonts = data.fonts.filter(f => f.type === 'private' || f.owner_id === currentUserId);
                    allPubFonts = data.fonts.filter(f => f.type === 'public' && f.owner_id !== currentUserId);
                    renderGrid('myFontsGrid', allMyFonts, true);
                    renderGrid('pubFontsGrid', allPubFonts, false);
                } else { renderGrid('myFontsGrid', [], true); renderGrid('pubFontsGrid', [], false); }
            } catch(e) { document.getElementById('myFontsGrid').innerHTML = '<p class="text-danger">Error.</p>'; }
            finally { document.getElementById('myFontsLoader').style.display = 'none'; document.getElementById('pubFontsLoader').style.display = 'none'; }
        }
        
        document.getElementById('fontSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            renderGrid('myFontsGrid', allMyFonts.filter(f => f.name.toLowerCase().includes(term)), true);
            renderGrid('pubFontsGrid', allPubFonts.filter(f => f.name.toLowerCase().includes(term)), false);
        });

        function renderGrid(gridId, fonts, isPrivate) {
            const grid = document.getElementById(gridId);
            const lang = localStorage.getItem('fontify_lang') || 'tr';
            const t = translations[lang];
            
            grid.innerHTML = '';
            
            if (fonts.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'text-center w-100 text-muted col-12 py-5';
                emptyDiv.innerHTML = `<i class="bi bi-inbox fs-1"></i><p>${isPrivate ? t.no_font : t.no_result}</p>`;
                grid.appendChild(emptyDiv);
                return;
            }

            fonts.forEach(f => {
                const vCount = f.repetition ? f.repetition + 'x' : '3x'; 
                const charCount = f.char_count ? f.char_count : '---';
                const isOwner = f.owner_id === currentUserId;
                const isPublic = f.type === 'public';
                
                let badgeText = '';
                if (isOwner) {
                    badgeText = isPublic ? (lang === 'en' ? 'Public' : 'Yayƒ±nda') : (lang === 'en' ? 'Private' : 'Gizli');
                } else {
                    badgeText = lang === 'en' ? 'Library' : 'K√ºt√ºphanemde';
                }

                const card = document.createElement('div');
                card.className = 'font-card';
                card.onclick = () => openPreview(f.id, f.name);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'card-actions';

                if (isOwner) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'action-btn delete-btn';
                    delBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    delBtn.onclick = (e) => deleteFont(e, f.id);
                    actionsDiv.appendChild(delBtn);
                } else if (isPrivate) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'action-btn delete-btn';
                    delBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
                    delBtn.onclick = (e) => deleteFont(e, f.id);
                    actionsDiv.appendChild(delBtn);
                }

                if (!isPrivate && !isOwner) {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'action-btn add-btn';
                    addBtn.innerHTML = '<i class="bi bi-plus-lg"></i>';
                    addBtn.onclick = (e) => addToLibrary(e, f.id);
                    actionsDiv.appendChild(addBtn);
                }

                if (isOwner) {
                    const iconClass = isPublic ? 'bi-eye' : 'bi-eye-slash';
                    const colorClass = isPublic ? 'text-success' : 'text-secondary';
                    const visBtn = document.createElement('button');
                    visBtn.className = `action-btn visibility-btn ${colorClass}`;
                    visBtn.innerHTML = `<i class="bi ${iconClass}"></i>`;
                    visBtn.onclick = (e) => toggleVisibility(e, f.id);
                    actionsDiv.appendChild(visBtn);
                }

                const badge = document.createElement('span');
                badge.className = 'badge-private';
                badge.textContent = badgeText;

                const preview = document.createElement('div');
                preview.className = 'font-preview';
                preview.textContent = 'Aa';

                const info = document.createElement('div');
                info.className = 'font-info';

                const name = document.createElement('div');
                name.className = 'font-name';
                name.textContent = f.name;

                const meta = document.createElement('div');
                meta.className = 'font-meta';
                
                const metaLeft = document.createElement('span');
                metaLeft.innerHTML = `<i class="bi bi-layers"></i> ${vCount}`;
                
                const metaRight = document.createElement('span');
                metaRight.innerHTML = `<i class="bi bi-grid-3x3"></i> ${charCount}`;

                meta.appendChild(metaLeft);
                meta.appendChild(metaRight);
                info.appendChild(name);
                info.appendChild(meta);

                card.appendChild(actionsDiv);
                card.appendChild(badge);
                card.appendChild(preview);
                card.appendChild(info);

                grid.appendChild(card);
            });
        }

        async function toggleVisibility(e, fontId) { 
            e.stopPropagation(); 
            try { 
                const idToken = await firebase.auth().currentUser.getIdToken();
                await fetch(`${API_URL}/api/toggle_visibility`, { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }, 
                    body: JSON.stringify({ user_id: currentUserId, font_id: fontId }) 
                }); 
                loadFonts(); 
            } catch(err) { alert(err.message); } 
        }
        async function addToLibrary(e, fontId) { e.stopPropagation(); try { await fetch(`${API_URL}/api/add_to_library`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: currentUserId, font_id: fontId }) }); setTimeout(loadFonts, 500); } catch(err) { alert(err.message); } }
        async function deleteFont(e, fontId) { e.stopPropagation(); if(!confirm("Delete?")) return; try { await db.collection('users').doc(currentUserId).collection('fonts').doc(fontId).delete(); try{ await db.collection('fonts').doc(fontId).delete(); }catch(i){} loadFonts(); } catch(err) { alert(err.message); } }
        
        async function openPreview(fontId, fontName) {
            currentPreviewFontId = fontId;
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            document.getElementById('previewTitle').textContent = fontName;
            const previewBody = document.getElementById('previewBody');
            previewBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            modal.show();
            try {
                const res = await fetch(`${API_URL}/api/get_assets?font_id=${fontId}&user_id=${currentUserId}`);
                const data = await res.json();
                if (data.success && data.assets) {
                    previewBody.innerHTML = '';
                    const container = document.createElement('div');
                    container.className = 'd-flex flex-wrap gap-2 justify-content-center';
                    
                    Object.keys(data.assets).sort().forEach(key => {
                        const imgs = data.assets[key];
                        if (imgs && imgs.length > 0) {
                            let src = imgs[0];
                            if (!src.startsWith('http') && !src.startsWith('data:')) src = `data:image/png;base64,${src}`;
                            
                            const item = document.createElement('div');
                            item.className = 'text-center bg-dark border border-secondary rounded p-2';
                            item.style.width = '60px';
                            item.style.height = '80px';
                            
                            const img = document.createElement('img');
                            img.src = src;
                            img.style.maxHeight = '40px';
                            img.style.maxWidth = '100%';
                            img.style.objectFit = 'contain';
                            
                            item.appendChild(img);
                            container.appendChild(item);
                        }
                    });
                    previewBody.appendChild(container);
                }
            } catch(e) { console.error(e); }
        }
        document.getElementById('useFontBtn').addEventListener('click', () => { if(currentPreviewFontId) window.location.href = `editor.html?font_id=${encodeURIComponent(currentPreviewFontId)}`; });
    </script>
</body>
</html>